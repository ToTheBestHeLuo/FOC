/*
 * @Author: ToTheBestHeLuo 2950083986@qq.com
 * @Date: 2024-07-04 09:16:17
 * @LastEditors: error: error: git config user.name & please set dead value or install git && error: git config user.email & please set dead value or install git & please set dead value or install git
 * @LastEditTime: 2024-08-16 14:43:23
 * @FilePath: \MDK-ARMd:\stm32cube\stm32g431rbt6_advanced\FOC\source\mcMath.c
 * @Description: 
 * 
 * Copyright (c) 2024 by ${git_name_email}, All Rights Reserved. 
 */
#include "../include/mcType.h"
#include "../interface/mcConfig.h"
#include "../include/mcMath.h"

#define sqrt3 1.732050807568877f

bool CalculateIsInLimited(f32_t in,f32_t limit)
{
    limit = abs(limit);
    in = abs(in);
    if(in > limit) return false;
    return true;
}

f32_t CalculateSquare(f32_t in)
{
    return in * in;
}

Components2 CalculateSinCosValue(f32_t eleAngle)
{
    Components2 sinCos = Hardware_GetSinCosVal(eleAngle);
    return sinCos;
}
Components2 Abc_AlphaBeta_Trans(_FORCE Components2* ab)
{
    Components2 alphaBeta;
    alphaBeta.com1 = ab->com1;
    alphaBeta.com2 = sqrt3 / 3.f * (2.f * ab->com2 + ab->com1);
    return alphaBeta;
}
Components3 AlphaBeta_Abc_Trans(_FORCE Components2* alphaBeta)
{
    Components3 abc;
    f32_t alpha = alphaBeta->com1;
    f32_t beta = alphaBeta->com1;
    abc.com1 = alpha + sqrt3 / 3.f * beta;
    abc.com2 = sqrt3 * 2.f / 3.f * beta;
    abc.com3 = -(abc.com1 + abc.com2);
    return abc;
}
Components2 AlphaBeta_Dq_Trans(_FORCE Components2* alphaBeta,_FORCE Components2* sinCos)
{
    Components2 dq;
    dq.com1 = sinCos->com2 * alphaBeta->com1 + sinCos->com1 * alphaBeta->com2;
    dq.com2 = -sinCos->com1 * alphaBeta->com1 + sinCos->com2 * alphaBeta->com2;
    return dq;
}
Components2 Dq_AlphaBeta_Trans(_FORCE Components2* dq,_FORCE Components2* sinCos)
{
    Components2 alphaBeta;
    alphaBeta.com1 = sinCos->com2 * dq->com1 - sinCos->com1 * dq->com2;
    alphaBeta.com2 = sinCos->com1 * dq->com1 + sinCos->com2 * dq->com2;
    return alphaBeta;
}
f32_t FastSquareRoot(f32_t x)
{
    return Hardware_FastSquareRoot(x);
}
f32_t FastReciprocalSquareRoot(f32_t x)
{
    return Hardware_FastReciprocalSquareRoot(x);
}
f32_t Min3(f32_t x1,f32_t x2,f32_t x3)
{
    f32_t min = x1;
    if(min > x2)
        min = x2;
    if(min > x3)
        min = x3;
    return min;
}
f32_t Max3(f32_t x1,f32_t x2,f32_t x3)
{
    f32_t max = x1;
    if(max < x2)
        max = x2;
    if(max < x3)
        max = x3;
    return max;
}

f32_t MedianFilter(f32_t datBuffer[],uint16_t length)
{
    f32_t res = 0.f;

    if(length < 3){
        return res;
    }

    for(int i = 0;i < length - 1;++i){
        for(int j = 0;j < length - i - 1;++j){
            if(datBuffer[j] > datBuffer[j + 1]){
                f32_t tmp = datBuffer[j];
                datBuffer[j] = datBuffer[j + 1];
                datBuffer[j + 1] = tmp;
            }
        }
    }

    return datBuffer[length / 2];
}

uint32_t plook_evencg(f32_t u, f32_t bp0, f32_t bpSpace, uint32_t
    maxIndex, f32_t* fraction)
{
    f32_t fbpIndex;
    f32_t invSpc;
    uint32_t bpIndex;

    invSpc = 1.0f / bpSpace;
    fbpIndex = (u - bp0) * invSpc;
    if (fbpIndex < maxIndex) {
        bpIndex = (uint32_t)fbpIndex;
        *fraction = (u - ((f32_t)(uint32_t)fbpIndex * bpSpace + bp0)) * invSpc;
    }
    else {
        bpIndex = maxIndex - 1U;
        *fraction = 1.0f;
    }

    return bpIndex;
}

f32_t intrp1d_l(uint32_t bpIndex, f32_t frac, const f32_t table[])
{
    f32_t yL_0d0;

    yL_0d0 = table[bpIndex];
    return (table[bpIndex + 1U] - yL_0d0) * frac + yL_0d0;
}

f32_t atan2Rad(f32_t x1,f32_t x2)
{
    f32_t absInXVar;
    f32_t rtb_Atan2;
    static const f32_t tableData_c[255] = { 0.0, 0.000626591026761255,
      0.00125316262996467, 0.001879695389664802, 0.002506169893139322,
      0.0031325667384963776, 0.0037588665382769179, 0.0043850499230503187,
      0.005011097545001641, 0.00563699008150886, 0.0062627082387084251,
      0.0068882327550474952, 0.0075135444048212508, 0.0081386240016936319,
      0.0087634524021999363, 0.0093880105092296658, 0.010012279275488067,
      0.010636239706934825, 0.011259872866198353, 0.011883159875964194,
      0.01250608192233604, 0.013128620258167894, 0.013750756206365957,
      0.014372471163158797, 0.014993746601334438, 0.01561456407344299,
      0.016234905214963517, 0.016854751747433786, 0.017474085481541685,
      0.018092888320177043, 0.018711142261442645, 0.019328829401623254,
      0.019945931938111543, 0.020562432172289771, 0.021178312512366206,
      0.021793555476165152, 0.022408143693869724, 0.023022059910716295,
      0.023635286989639744, 0.02424780791386856, 0.024859605789469115,
      0.025470663847838072, 0.026080965448142347, 0.026690494079705807,
      0.02729923336434199, 0.027907167058632359, 0.028514279056149224,
      0.029120553389623011, 0.02972597423305319, 0.030330525903762461,
      0.030934192864393681, 0.031536959724849212, 0.032138811244172234,
      0.032739732332369743, 0.033339708052176967, 0.0339387236207629,
      0.034536764411376784, 0.035133815954935324, 0.035729863941550595,
      0.036324894221998465, 0.036918892809127454, 0.03751184587920816,
      0.038103739773223129, 0.038694560998097191, 0.039284296227868595,
      0.03987293230480074, 0.040460456240434969, 0.041046855216584355,
      0.041632116586268926, 0.042216227874592456, 0.042799176779561174,
      0.043380951172844635, 0.0439615391004793, 0.04454092878351492,
      0.045119108618604409, 0.045696067178537456, 0.046271793212718515,
      0.046846275647589419, 0.047419503586997487, 0.047991466312509286,
      0.048562153283670959, 0.049131554138215419, 0.049699658692217291,
      0.050266456940196, 0.050831939055167842, 0.051396095388647596,
      0.051958916470600414, 0.05252039300934476, 0.053080515891406992,
      0.053639276181328452, 0.054196665121425784, 0.054752674131505211,
      0.055307294808531658, 0.0558605189262534, 0.05641233843478316,
      0.056962745460136431, 0.057511732303727789, 0.058059291441826165,
      0.058605415524969874, 0.059150097377342156, 0.059693329996108345,
      0.060235106550715192, 0.060775420382153576, 0.061314265002185217,
      0.061851634092534358, 0.0623875215040454, 0.0629219212558072,
      0.063454827534245084, 0.063986234692181371, 0.0645161372478653,
      0.06504452988397337, 0.065571407446580771, 0.066096764944104991,
      0.066620597546222432, 0.0671429005827588, 0.067663669542554317,
      0.068182900072304514, 0.068700587975377592, 0.069216729210609035,
      0.069731319891074492, 0.070244356282841772, 0.070755834803702691,
      0.071265752021885689, 0.071774104654750065, 0.072280889567462661,
      0.072786103771657631, 0.073289744424080455, 0.073791808825216632,
      0.074292294417906121, 0.074791198785944063, 0.075288519652668751,
      0.075784254879537646, 0.07627840246469185, 0.076770960541510183,
      0.077261927377153414, 0.077751301371099257, 0.078239081053669,
      0.07872526508454647, 0.07920985225128982, 0.0796928414678371,
      0.080174231773005977, 0.08065402232898837, 0.08113221241984088,
      0.081608801449971041, 0.082083788942620667, 0.0825571745383465,
      0.083028957993498714, 0.083499139178698126, 0.083967718077312445,
      0.084434694783932188, 0.084900069502846676, 0.085363842546520921,
      0.085826014334073636, 0.0862865853897568, 0.086745556341437741,
      0.0872029279190836, 0.087658700953248972, 0.0881128763735673,
      0.088565455207245916, 0.089016438577565873, 0.0894658277023863,
      0.089913623892654226, 0.090359828550919744, 0.090804443169857432,
      0.091247469330793876, 0.091688908702242042, 0.092128763038442571,
      0.092567034177912469, 0.09300372404200144, 0.093438834633456161,
      0.093872368034992881, 0.094304326407878447, 0.094734711990520276,
      0.095163527097065242, 0.095590774116007957, 0.096016455508808621,
      0.09644057380852053, 0.096863131618427759, 0.097284131610692867,
      0.0977035765250151, 0.098121469167299274, 0.098537812408335118,
      0.098952609182487911, 0.099365862486399975, 0.099777575377703584,
      0.10018775097374502, 0.10059639245032057, 0.10100350304042365,
      0.10140908603300419, 0.10181314477173961, 0.10221568265381782,
      0.10261670312873242, 0.10301620969708987, 0.10341420590942917,
      0.10381069536505359, 0.10420568171087496, 0.10459916864027034,
      0.10499115989195118, 0.10538165924884509, 0.10577067053698998,
      0.10615819762444127, 0.10654424442019113, 0.10692881487310089,
      0.10731191297084594, 0.10769354273887323, 0.10807370823937164,
      0.10845241357025498, 0.1088296628641576, 0.10920546028744287,
      0.1095798100392241, 0.1099527163503983, 0.11032418348269254,
      0.11069421572772273, 0.11106281740606523, 0.11142999286634082,
      0.11179574648431129, 0.11216008266198824, 0.1125230058267546,
      0.11288452043049836, 0.11324463094875849, 0.11360334187988329,
      0.11396065774420087, 0.11431658308320175, 0.11467112245873334,
      0.11502428045220688, 0.11537606166381564, 0.11572647071176569,
      0.11607551223151781, 0.11642319087504149, 0.11676951131008041,
      0.1171144782194295, 0.11745809630022334, 0.1178003702632361,
      0.11814130483219268, 0.11848090474309089, 0.11881917474353505,
      0.11915611959208038, 0.11949174405758826, 0.11982605291859257,
      0.12015905096267641, 0.12049074298585981, 0.12082113379199767,
      0.12115022819218836, 0.12147803100419251, 0.12180454705186206,
      0.12212978116457962, 0.12245373817670753, 0.12277642292704719,
      0.12309784025830794, 0.12341799501658593, 0.12373689205085239,
      0.12405453621245152, 0.12437093235460782, 0.12468608533194264, 0.125 };

    if ((x1 == 0.0f) && (x2 == 0.0f)) {
        rtb_Atan2 = 0.0f;
    }
    else {
        f32_t uVarXTmp;
        uint32_t bpIdx;
        uint8_t quadrantInfo;
        bool isReciprocal;
        isReciprocal = false;
        if (x1 < 0.0f) {
            if (x2 < 0.0f) {
                quadrantInfo = 3U;
            }
            else {
                quadrantInfo = 4U;
            }
        }
        else if (x2 < 0.0f) {
            quadrantInfo = 2U;
        }
        else {
            quadrantInfo = 1U;
        }

        absInXVar = abs(x2);
        rtb_Atan2 = abs(x1);
        if (rtb_Atan2 > absInXVar) {
            uVarXTmp = rtb_Atan2;
            rtb_Atan2 = absInXVar;
            isReciprocal = true;
        }
        else {
            uVarXTmp = absInXVar;
        }

        bpIdx = plook_evencg(rtb_Atan2 / uVarXTmp, 0.0f, 0.003937007874015748f, 254U,
            &absInXVar);
        rtb_Atan2 = intrp1d_l(bpIdx, absInXVar, tableData_c);
        if (isReciprocal) {
            rtb_Atan2 = 0.25f - rtb_Atan2;
        }

        if (quadrantInfo == 2) {
            rtb_Atan2 = 0.5f - rtb_Atan2;
        }
        else if (quadrantInfo == 3) {
            rtb_Atan2 -= 0.5f;
        }
        else if (quadrantInfo == 4) {
            rtb_Atan2 = -rtb_Atan2;
        }
    }
    
    return rtb_Atan2 * 6.2831853071795862f;
}


